<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ESP32 Command Station</title>
  <link rel="icon" type="image/png" href="loco-32x32.png" sizes="32x32">
  <link rel="stylesheet" href="spectre.min.css">
  <script src="cash.min.js"></script>
  <style>
    .s88SensorOn {
      height: 25px;
      width: 40px;
      background-color: #00FF00;
      color: #FFFFFF;
    }

    .s88SensorOff {
      height: 25px;
      width: 40px;
      background-color: #FF0000;
      color: #FFFFFF;
    }

    fieldset {
      border-style: solid;
      border-width: 0.1rem;
      border-color: #606c76;
      border-radius: 0.5rem;
    }

    #ws-status.flash {
      animation-name: colorflash;
      animation-duration: 1s;
      animation-iteration-count: infinite;
      animation-timing-function: linear;
    }

    @keyframes colorflash {
      0% {
        filter: invert(0.8) sepia(1) saturate(3);
      }

      50% {
        filter: invert(0.5);
      }

      100% {
        filter: invert(0.8) sepia(1) saturate(3);
      }
    }
  </style>
</head>

<body class="bg-dark">
  <div class="hero hero-sm">
    <div class="hero-body">
      <h1>ESP32 Command Station
        <div class="btn-group float-right">
          <div class="tooltip tooltip-left" data-tooltip="Connection status to command station"><i id="ws-status"
              class="icon icon-wifi text-dark"></i></div>
          <div class="tooltip tooltip-left" data-tooltip="Send eStop to all locomotives"><i
              class="icon icon-stop text-error" onclick="ws('<estop>');"></i></div>
          <div class="tooltip tooltip-left" data-tooltip="OPS track status"><i class="icon icon-shutdown text-error"
              id="ops_track_power"></i><small id="ops_usage"></small></div>
          <div class="tooltip tooltip-left" data-tooltip="Show active locomotives">
            <img class="icon"
              src="data:image/svg+xml,%3Csvg version='1.1' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 470 470' xmlns:xlink='http://www.w3.org/1999/xlink' enable-background='new 0 0 470 470'%3E%3Cg%3E%3Cpath style='fill:%23FFFFFF;' d='m404.791,457.196l-29.997-29.997c-0.005-0.005-28.072-28.072-28.072-28.072l36.805-5.254c4.018-0.573 6.851-4.239 6.392-8.272l-10.526-92.555c-0.431-3.79-3.638-6.652-7.452-6.652h-13.553v-24.788c13.911-3.38 24.273-15.934 24.273-30.87s-10.362-27.49-24.273-30.87v-55.694c0-4.143-3.358-7.5-7.5-7.5h-22.143c-2.519-31.78-20.901-59.163-47.208-74.211v-54.961c0-4.143-3.358-7.5-7.5-7.5h-78.115c-4.142,0-7.5,3.357-7.5,7.5v54.96c-26.307,15.048-44.689,42.431-47.208,74.211h-22.1c-4.142,0-7.5,3.357-7.5,7.5v55.694c-13.911,3.38-24.273,15.934-24.273,30.87s10.362,27.49 24.273,30.87v24.788h-13.554c-3.814,0-7.021,2.862-7.452,6.652l-10.526,92.555c-0.458,4.033 2.374,7.699 6.392,8.272l36.805,5.254-28.069,28.07c-0.001,0.001-30,30-30,30-2.145,2.146-2.787,5.371-1.626,8.174 1.161,2.803 3.896,4.63 6.929,4.63h328.975c3.034,0 5.768-1.827 6.929-4.63 1.16-2.803 0.519-6.028-1.626-8.174zm-37.131-226.461c0,9.248-7.524,16.772-16.773,16.772s-16.772-7.524-16.772-16.772 7.524-16.772 16.772-16.772 16.773,7.524 16.773,16.772zm-24.273-30.87c-13.911,3.38-24.272,15.934-24.272,30.87s10.362,27.49 24.272,30.87v24.788h-58.803v-62.337c24.67-15.375 41.739-41.849 44.16-72.386h14.643v48.195zm-143.013,86.529v-54.754c10.716,4.255 22.392,6.596 34.605,6.596 12.213,0 23.889-2.341 34.605-6.596v54.754h-69.21zm3.047-271.394h63.115v40.558c-9.869-3.525-20.492-5.452-31.558-5.452s-21.688,1.927-31.558,5.452v-40.558zm31.559,50.106c43.596,0 79.064,35.468 79.064,79.064s-35.468,79.064-79.064,79.064-79.064-35.468-79.064-79.064 35.467-79.064 79.064-79.064zm-132.639,165.629c0-9.248 7.524-16.772 16.773-16.772s16.772,7.524 16.772,16.772-7.524,16.772-16.772,16.772-16.773-7.524-16.773-16.772zm24.273,30.871c13.911-3.38 24.272-15.934 24.272-30.87s-10.362-27.49-24.272-30.87v-48.194h14.6c2.421,30.537 19.49,57.011 44.16,72.386v62.337h-58.761v-24.789zm-21.857,39.788h53.701l-3.913,64.934c-0.249,4.135 2.9,7.688 7.035,7.938 0.154,0.01 0.306,0.014 0.458,0.014 3.936,0 7.24-3.068 7.479-7.049l3.967-65.836h53.997l.01,75.804c0,4.143 3.359,7.5 7.501,7.499s7.5-3.358 7.499-7.501l-.01-75.802h53.946l3.513,65.862c0.213,4.001 3.523,7.101 7.483,7.101 0.134,0 0.27-0.003 0.406-0.011 4.136-0.221 7.311-3.753 7.09-7.889l-3.471-65.063h53.798l8.946,78.66-139.19,19.87-139.191-19.871 8.946-78.66zm129.185,113.532c0.352,0.05 0.706,0.075 1.06,0.075s0.708-0.025 1.06-0.075l92.097-13.148 23.223,23.222h-232.76l23.223-23.222 92.097,13.148zm-145.32,40.074l15-15h262.76l15,15h-292.76z'/%3E%3Cpath style='fill:%23FFFFFF;' d='m234.979,185.604c22.846,0 41.433-18.587 41.433-41.433s-18.586-41.433-41.433-41.433-41.433,18.587-41.433,41.433 18.586,41.433 41.433,41.433zm0-67.866c14.575,0 26.433,11.857 26.433,26.433s-11.857,26.433-26.433,26.433-26.433-11.857-26.433-26.433 11.857-26.433 26.433-26.433z'/%3E%3C/g%3E%3C/svg%3E"
              onclick="showActiveLocos(this);"></div>
        </div>
      </h1>
    </div>
  </div>
  <header class="navbar">
    <section class="navbar-section btn-group">
      <button class="btn btn-primary" onclick="showTab('#tab-throttle', this);">Throttle</button>
      <button class="btn btn-primary" onclick="showTab('#tab-turnouts', this);">Turnouts</button>
      <button class="btn btn-primary" onclick="showTab('#tab-roster', this);">Locomotive Roster</button>
      <button class="btn btn-primary" onclick="showTab('#tab-prog', this);">Programmer</button>
      <button class="btn btn-primary" onclick="showTab('#tab-olcbconfig', this);">OpenLCB (LCC)
        Configuration</button>
      <button class="btn btn-primary" onclick="showTab('#tab-ota', this);">Firmware Update</button>
    </section>
  </header>
  <div class="container">
    <div class="container" id="tab-throttle">
      <div class="columns">
        <div class="column col-3"><label>Locomotive:<input class="form-input" type="number" readonly="true"
              id="loco-address" value="0" /></label></div>
        <div class="column col-3"><label for="loco-dir">Direction:</label>
          <button id="loco-dir" class="btn btn-primary"><span class="icon icon-forward"></span></button>
        </div>
        <div class="column col-3">
          <button class="btn btn-primary" onclick="toggleModal('#loco-select');">Change
            Locomotive</button>
        </div>
      </div>
      <div class="columns">
        <div class="column"><label for="loco-speed">Speed:</label><input class="bar bar-slider" type="range"
            id="loco-speed" min="0" max="126" value="0" /></div>
      </div>
      <div class="columns">
        <div class="column">Functions:</div>
      </div>
      <div class="columns">
        <div class="column"><button class="btn btn-primary" id="funct_0">FL<span class="icon"
              id="funct_0_icon"></span></button></div>
        <div class="column"><button class="btn btn-primary" id="funct_1">F1</span><span class="icon"
              id="funct_1_icon"></span></button></div>
        <div class="column"><button class="btn btn-primary" id="funct_2">F2<span class="icon"
              id="funct_2_icon"></span></button></div>
        <div class="column"><button class="btn btn-primary" id="funct_3">F3<span class="icon"
              id="funct_3_icon"></span></button></div>
        <div class="column"><button class="btn btn-primary" id="funct_4">F4<span class="icon"
              id="funct_4_icon"></span></button></div>
      </div>
      <div class="columns">
        <div class="column"></div>
        <div class="column"><button class="btn btn-primary" id="funct_5">F5<span class="icon"
              id="funct_5_icon"></span></button></div>
        <div class="column"><button class="btn btn-primary" id="funct_6">F6<span class="icon"
              id="funct_6_icon"></span></button></div>
        <div class="column"><button class="btn btn-primary" id="funct_7">F7<span class="icon"
              id="funct_7_icon"></span></button></div>
        <div class="column"><button class="btn btn-primary" id="funct_8">F8<span class="icon"
              id="funct_8_icon"></span></button></div>
      </div>
      <details class="accordion" id="ext_funcs">
        <summary class="accordion-header c-hand"><button id="btn-ext_funcs" class="btn btn-primary">F9-F28<span
              class="icon icon-arrow-down"></span></button></summary>
        <div class="accordion-body">
          <div class="columns">
            <div class="column"></div>
            <div class="column"><button class="btn btn-primary" id="funct_9">F9<span class="icon"
                  id="funct_9_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_10">F10<span class="icon"
                  id="funct_10_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_11">F11<span class="icon"
                  id="funct_11_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_12">F12<span class="icon"
                  id="funct_12_icon"></span></button></div>
          </div>
          <div class="columns">
            <div class="column"></div>
            <div class="column"><button class="btn btn-primary" id="funct_13">F13<span class="icon"
                  id="funct_13_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_14">F14<span class="icon"
                  id="funct_14_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_15">F15<span class="icon"
                  id="funct_15_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_16">F16<span class="icon"
                  id="funct_16_icon"></span></button></div>
          </div>
          <div class="columns">
            <div class="column"></div>
            <div class="column"><button class="btn btn-primary" id="funct_17">F17<span class="icon"
                  id="funct_17_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_18">F18<span class="icon"
                  id="funct_18_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_19">F19<span class="icon"
                  id="funct_19_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_20">F20<span class="icon"
                  id="funct_20_icon"></span></button></div>
          </div>
          <div class="columns">
            <div class="column"></div>
            <div class="column"><button class="btn btn-primary" id="funct_21">F21<span class="icon"
                  id="funct_21_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_22">F22<span class="icon"
                  id="funct_22_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_23">F23<span class="icon"
                  id="funct_23_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_24">F24<span class="icon"
                  id="funct_24_icon"></span></button></div>
          </div>
          <div class="columns">
            <div class="column"></div>
            <div class="column"><button class="btn btn-primary" id="funct_25">F25<span class="icon"
                  id="funct_25_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_26">F26<span class="icon"
                  id="funct_26_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_27">F27<span class="icon"
                  id="funct_27_icon"></span></button></div>
            <div class="column"><button class="btn btn-primary" id="funct_28">F28<span class="icon"
                  id="funct_28_icon"></span></button></div>
          </div>
        </div>
      </details>
      <div class="modal" id="loco-select">
        <a href="#" class="modal-overlay" title="Cancel" onclick="toggleModal('#loco-select');"></a>
        <div class="modal-container">
          <div class="modal-header">
            <button class="btn btn-primary float-right" title="Cancel" onclick="toggleModal('#loco-select');"><span
                class="icon icon-cross"></span></button>
            <div class="modal-title h5">Select Locomotive</div>
          </div>
          <div class="modal-body">
            <table id="loco-list">
              <thead>
                <tr>
                  <th>Address</th>
                  <th>Type</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
            <div id="loco-manual">
              <label class="form-label text-dark" for="loco-manual-address">Address</label>
              <input class="form-input" type="number" pattern="[0-9]*" id="loco-manual-address" value="1" min="1"
                max="16384">
            </div>
          </div>
          <div class="modal-footer">
            <button id="loco-select-add" class="btn btn-primary" title="Manual"><span
                class="icon icon-plus"></span></button>
            <button id="loco-select-select" class="btn btn-primary" title="Select"><span
                class="icon icon-check"></span></button>
          </div>
        </div>
      </div>
    </div>
    <div class="container" style="display:none;" id="tab-turnouts">
      <div class="empty bg-dark" id="turnouts-empty">
        <div class="empty-title">No turnouts have been defined yet</div>
        <div class="empty-subtitle">Click the add button below to define a turnout.</div>
      </div>
      <div class="container">
        <table id="turnouts-table" style="display:none;">
          <thead>
            <tr>
              <th>Address</th>
              <th>Type</th>
              <th>State</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
      <div class="container">
        <button id='turnout-create' title='Create' class='btn btn-lg btn-action btn-primary'><span
            class="icon icon-plus"></span></button>
        <button id='turnout-refresh' title='Refresh' class='btn btn-lg btn-action btn-primary'><span
            class="icon icon-refresh"></span></button>
      </div>
      <div id="turnout-editor" class="modal modal-sm">
        <a href="#" class="modal-overlay" title="Cancel" onclick="toggleModal('#turnout-editor');"></a>
        <div class="modal-container">
          <div class="modal-header">
            <div class="modal-title h5">Turnout Editor</div>
          </div>
          <div class="modal-body">
            <label class="form-label text-dark" for="turnout-address">Address:</label>
            <input type="number" pattern="[0-9]*" id="turnout-address" value="1" min="1" max="2044">
            <label class="form-label text-dark" for="turnout-type">Type:</label>
            <select id="turnout-type">
              <option value="0">Left</option>
              <option value="1">Right</option>
              <option value="2">Wye</option>
              <option value="3">Multi (threeway/etc)</option>
            </select>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary float-right" title="Cancel" onclick="toggleModal('#turnout-editor');"><span
                class="icon icon-cross"></span></button>
            <button id="turnout-save" class="btn btn-primary" title="Save"><span
                class="icon icon-check"></span></button>
          </div>
        </div>
      </div>
    </div>
    <div class="container" style="display:none;" id="tab-roster">
      <div class="empty bg-dark" id="roster-empty">
        <div class="empty-title">No locomotives have been created yet</div>
        <div class="empty-subtitle">Click the add button below to create a locomotive.</div>
      </div>
      <div class="container">
        <table id="roster-table" style="display:none;">
          <thead>
            <tr>
              <th>Address</th>
              <th>Name</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
      <div class="container">
        <button id='roster-create' title='Create' class='btn btn-lg btn-action btn-primary'
          onclick="toggleModal('#roster-editor');"><span class="icon icon-plus"></span></button>
        <button id='roster-refresh' title='Refresh' class='btn btn-lg btn-action btn-primary'><span
            class="icon icon-refresh"></span></button>
      </div>
      <div id="roster-editor" class="modal">
        <a href="#" class="modal-overlay" title="Cancel" onclick="toggleModal('#roster-editor');"></a>
        <div class="modal-container">
          <div class="modal-header">
            <div class="modal-title h5">Locomotive Editor</div>
          </div>
          <div class="modal-body">
            <label class="form-label text-dark" for="roster-addr">Address:</label>
            <input type="number" pattern="[0-9]*" id="roster-addr" value="1" min="1" max="16384" />
            <label class="form-label text-dark" for="roster-name">Name:</label>
            <input type="text" id="roster-name" value="" />
            <label class="form-switch">
              <input type="checkbox" id="roster-idle">
              <i class="form-icon"></i><span class="text-dark">Automatically add this locomotive to the "Active
                Locomotives" list on Command Station startup?</span>
            </label>
            <label class="form-switch">
              <input type="checkbox" id="roster-default">
              <i class="form-icon"></i><span class="text-dark">Include this locomotive in the Throttle locomotive
                list?</span>
            </label>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary float-right" title="Cancel" onclick="toggleModal('#roster-editor');"><span
                class="icon icon-cross"></span></button>
            <button id="roster-save" class="btn btn-primary" title="Save"><span class="icon icon-check"></span></button>
          </div>
        </div>
      </div>
    </div>
    <div class="container" style="display:none;" id="tab-prog">
      <div class="columns">
        <div class="column"><label for="cs-prog-action">Action:</label></div>
        <div class="column"><select id="cs-prog-action">
            <option value="write">Write</option>
            <option value="read">Read</option>
            <option value="identify">Identify Address</option>
          </select>
        </div>
      </div>
      <div class="columns" id="cs-prog-div-target">
        <div class="column"><label for="cs-prog-target">Programming Mode:</label></div>
        <div class="column"><select id="cs-prog-target">
          <option value="prog">PROG</option>
          <option value="ops">OPS</option>
        </select></div>
      </div>
      <div class="columns" id="cs-prog-div-addr">
        <div class="column"><label for="cs-prog-addr">DCC Address:</label></div>
        <div class="column"><input type="number" pattern="[0-9]*" id="cs-prog-addr" value="1" min="1" max="16384">
        </div>
      </div>
      <div class="columns" id="cs-prog-div-cv">
        <div class="column"><label for="cs-prog-cv">CV:</label></div>
        <div class="column"><input type="number" pattern="[0-9]*" id="cs-prog-cv" value="1" min="1" max="1024">
        </div>
      </div>
      <div class="columns" id="cs-prog-div-mode">
        <div class="column"><label for="cs-prog-mode">Mode:</label></div>
        <div class="column"><select id="cs-prog-mode">
          <option value="byte">Byte</option>
          <option value="bit">Bit</option>
        </select></div>
      </div>
      <div class="columns" id="cs-prog-div-value" style="display:none;">
        <div class="column"><label for="cs-prog-cv-value">Value:</label></div>
        <div class="column"><input type="number" pattern="[0-9]*" id="cs-prog-cv-value" value="1" min="1" max="255">
        </div>
      </div>
      <div class="columns" id="cs-prog-div-bit" style="display:none;">
        <div class="column"><label for="cs-prog-cv-bit">Bit:</label></div>
        <div class="column"><input type="number" pattern="[0-7]*" id="cs-prog-cv-bit" value="0" min="0" max="7">
        </div>
        <div class="column" id="cs-prog-div-bit-value"><input type="checkbox" id="cs-prog-cv-bit-value"
            data-role="flipswitch" data-off-text="Off" data-on-text="On"></div>
      </div>
      <div class="columns" id="cs-prog-div-create-roster" style="display:none;">
        <div class="column"><label class="form-switch">
            <input type="checkbox" id="cs-prog-create-roster">
            <i class="form-icon"></i>Create Roster entry?
          </label></div>
      </div>
      <div class="columns">
        <div class="column"><button class="btn btn-primary" id="cs-prog-execute">Execute</button></div>
      </div>
      <div class="columns">
        <div class="column column-12"><textarea id="cs-prog-result"></textarea></div>
      </div>
    </div>
    <div class="container" style="display:none;" id="tab-olcbconfig">
    </div>
    <div class="container" style="display:none;" id="tab-ota">
      <div class="columns">
        <form id="cs-ota-form" class="form-horizontal">
          <div class="input-group">
            <span class="input-group-addon addon-lg text-light bg-dark">Firmware:</span>
            <input class="form-input input-lg" type="file" name="cs-ota-firmware"
              placeholder="ESP32CommandStation.bin" />
            <button class="btn btn-primary input-group-btn btn-lg" id="cs-ota-upload">Upload</button>
          </div>
        </form>
      </div>
    </div>
    <div class="modal" id="active-locos">
      <a href="#" class="modal-overlay" title="Cancel" onclick="toggleModal('#active-locos');"></a>
      <div class="modal-container">
        <div class="modal-header">
          <button class="btn btn-primary float-right" title="Cancel" onclick="toggleModal('#active-locos');"><span
              class="icon icon-cross"></span></button>
          <div class="modal-title h5">Active Locomotives</div>
        </div>
        <div class="modal-body">
          <div class="empty" id="active-locos-empty">
            <div class="empty-title h5">There are no active locomotives</div>
          </div>
          <table class="table table-stripped text-dark" id="active-locos-table">
            <thead>
              <tr>
                <th>Address</th>
                <th>Speed</th>
                <th>Direction</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    var sendLocoEvents = true;
    var firePowerEvents = true;
    var webSocket = null;
    var ws_pending_send = [];
    var s88SensorIDBase = 512;
    var cdi_loaded = true;
    function showTab(target, button) {
      $('[id^=tab-]').hide();
      $(button).parent().children().removeClass('active');
      $(button).parent().children().addClass('inactive');
      $(button).toggleClass('active');
      $(button).toggleClass('inactive');
      if (target === '#tab-olcbconfig' && !cdi_loaded) {
        $(button).toggleClass('loading');
      } else {
        $(target).show();
      }
    }
    function toggleModal(target) {
      $(target).toggleClass('active');
    }
    function updateTrackPowerStatus(trackStatus, overcurrent = false) {
      $('#ops_track_power').removeClass('loading');
      $('#ops_track_power').removeClass('text-success');
      $('#ops_track_power').removeClass('text-error');
      if (trackStatus) {
        if (overcurrent) {
          $('#ops_track_power').addClass('text-warning');
        } else {
          $('#ops_track_power').addClass('text-success');
        }
      } else {
        $('#ops_track_power').addClass('text-error');
      }
    }
    function showActiveLocos(button) {
      if (window.location.host.length) {
        $(button).toggleClass('loading');
        fetch('/locomotive').then(res => res.json()).then(data => {
          $(button).toggleClass('loading');
          console.log(data);
          if (data.length) {
            var tbody = $('#active-locos-table tbody');
            tbody.children().remove();
            for (var idx in data) {
              $(tbody).append(String.format('<tr><td>{0}</td><td>{1}</td><td>{2}</td></tr>', data[idx].address, data[idx].speed, data[idx].dir));
            }
            $('#active-locos-empty').hide();
            $('#active-locos-table').show();
          } else {
            $('#active-locos-empty').show();
            $('#active-locos-table').hide();
          }
          toggleModal('#active-locos');
        });
      } else {
        $('#active-locos-empty').show();
        $('#active-locos-table').hide();
        toggleModal('#active-locos');
      }
    }
    function showErrorDialog(text, error) {
      error = typeof error !== 'undefined' ? error : "";
      setTimeout(function () { alert(text); console.log(text, error); }, 500);
    }
    function connectWebSocket() {
      if (!window.location.host.length) {
        while (ws_pending_send.length) {
          console.log(ws_pending_send.pop());
        }
        return;
      }
      $('#ws-status').toggleClass('flash');
      var socketUrl = String.format('ws://{0}:{1}/ws', window.location.host, window.location.port);
      webSocket = new WebSocket(socketUrl);
      webSocket.addEventListener('open', (event) => {
        $('#ws-status').toggleClass('flash');
        while (ws_pending_send.length) {
          webSocket.send(ws_pending_send.pop());
        }
        $('#ws-status').removeClass('text-dark');
        $('#ws-status').addClass('text-success');
      });
      webSocket.addEventListener('message', (event) => {
        var messages = event.data.split(/[<>]+/);
        $(messages).each(idx => {
          var msg = messages[idx];
          if (msg !== "") {
            console.log('WS-RX:', msg);
            var msg_parts = msg.split(' ');
            switch (msg_parts[0]) {
              case 'A': // track utilization
                if (msg_parts[1] === 'OPS') {
                  $('#ops_usage').text(String.format('{0} mA', msg_parts[2]));
                  $('#ops_usage').show();
                  $('#ops_track_power').removeClass('loading');
                }
                break;
              case 'p0': // track off
                if (msg_parts[1] === 'OPS') {
                  updateTrackPowerStatus(false);
                  $('#ops_usage').hide();
                }
                break;
              case 'p1': // track on
                if (msg_parts[1] === 'OPS') {
                  updateTrackPowerStatus(true);
                }
                break;
              case 'p2': // track overcurrent
                if (msg_parts[1] === 'OPS') {
                  updateTrackPowerStatus(true, true);
                }
                break;
              case 'T': // active loco
                break;
              case 'Tex': // loco update
                $("#loco-address").val(msg_parts[1]);
                $("#loco-speed").val(msg_parts[2]);
                $('#loco-dir span').removeClass('icon-back');
                $('#loco-dir span').removeClass('icon-forward');
                if (msg_parts[3] === '1') {
                  $('#loco-dir span').addClass('icon-back');
                } else {
                  $('#loco-dir span').addClass('icon-forward');
                }
              default:
              // do nothing
            }
          }
        });
      });
      webSocket.addEventListener('error', (event) => {
        console.error('WS-EVT:', event);
        $('#ws-status').addClass('text-dark');
        $('#ws-status').removeClass('text-success');
      });
      webSocket.addEventListener('close', (event) => {
        console.warn('WS-EVT:', event);
        $('#ws-status').addClass('text-dark');
        $('#ws-status').removeClass('text-success');
      });
    }
    function ws(cmd) {
      // if the socket is not in an open state, defer the send until we have connected
      if (!webSocket || webSocket.readyState != WebSocket.OPEN) {
        ws_pending_send.push(cmd);
        // if we are not already trying to connect try and connect now
        if (!webSocket || webSocket.readyState != WebSocket.CONNECTING) {
          connectWebSocket();
        }
        return;
      }
      console.log('WS-TX:', cmd);
      webSocket.send(cmd);
    }
    $(function () {
      if (!String.format) {
        String.format = function (format) {
          var args = Array.prototype.slice.call(arguments, 1);
          return format.replace(/{(\d+)}/g, function (match, number) {
            return typeof args[number] != 'undefined'
              ? args[number]
              : match
              ;
          });
        };
      }
      if (window.location.host.length) {
        fetch('/config?features').then(res => res.json()).then(data => {
          connectWebSocket();
          if (data.sensors === false) {
            $('[id^=cs-sensors]').hide();
          }
          if (data.outputs === false) {
            $('[id^=cs-outputs]').hide();
          }
          if (data.s88 === false) {
            $('[id^=cs-sensors-s88]').hide();
          } else {
            s88SensorIDBase = data.sensorIDBase;
          }
          // setup 25sec timer for requesting status
          setInterval(function () { ws('<s>'); }, 25000);
        });
      }
      setupThrottle();
      setupTurnouts();
    });
    function setupThrottle() {
      $('#btn-ext_funcs').on('click', function () {
        var icon = $('#ext_funcs').contents().find('span').first();
        if ($('#ext_funcs').attr('open')) {
          $('#ext_funcs').removeAttr('open');
        } else {
          $('#ext_funcs').attr('open', 'open');
        }
        $(icon).toggleClass('icon-arrow-down');
        $(icon).toggleClass('icon-arrow-up');
      });
      $("#loco-speed").on("change", function (event, ui) {
        var selectedLoco = $("#loco-address").val();
        var speed = $("#loco-speed").val();
        var cmd = String.format('<tex {0} {1} -1>', selectedLoco, speed);
        if (sendLocoEvents) {
          ws(cmd);
        }
      });
      $('#loco-select-select').on('click', function () {
        toggleModal('#loco-select');
        changeLocomotive($('#loco-manual-address').val());
      })
      $("#loco-dir").on('click', function () {
        var selectedLoco = $("#loco-address").val();
        var icon = $('#loco-dir').contents().first();
        var dir = $(icon).hasClass('icon-forward');
        $(icon).toggleClass('icon-back');
        $(icon).toggleClass('icon-forward');
        var cmd = String.format('<tex {0} -1 {1}>', selectedLoco, dir ? '1' : '0');
        if (sendLocoEvents) {
          ws(cmd);
        }
      });
      if (window.location.host.length) {
        $("#loco-manual").hide();
        $("#loco-select-add").on("click", function () {
          $("#loco-list").hide();
          $("#loco-manual").show();
        });
      } else {
        $("#loco-list").hide();
        $("#loco-manual").show();
        $("#loco-select-add").hide();
      }
      $('[id^=funct_]').on('click', function (event) {
        var id = $(event.target).prop('id').match(/.*(\d+).*/)[1];
        var loco = $("#loco-address").val();
        var icon = String.format('#funct_{0}_icon', id);
        var state = $(icon).hasClass('icon-circle-check');
        $(icon).toggleClass('icon-circle-check');
        var cmd = String.format('<fex {0} {1} {2}>', loco, id, state ? '1' : '0');
        if (sendLocoEvents) {
          ws(cmd);
        }
      });
      $('#ops_track_power').on('click', function (event) {
        if ($(this).hasClass('text-error')) {
          ws('<1>');
        } else {
          ws('<0>');
        }
        $('this').toggleClass('loading');
      });
    }
    function setupTurnouts() {
      $('#turnout-create').on('click', function () {
        $('#turnout-address').val(1);
        $('#turnout-type').val(0);
        toggleModal('#turnout-editor');
      });
      $('#turnout-save').on('click', function () {
        toggleModal('#turnout-editor');
      });
    }
    function enableDisableLocoInputs() {
      $('[id^=funct_]').toggleClass('disabled');
      $('#loco-dir').toggleClass('disabled');
      $('#loco-speed').toggleClass('disabled');
      $('#throttle-release-loco').toggleClass('disabled');
    }
    function changeLocomotive(newAddress) {
      if (newAddress !== "") {
        console.log("selected loco:", newAddress);
        ws(String.format('<tex {0} 0 0>', newAddress));
      }
    }
    function save_cdi_field(field) {

    }
    function refresh_cdi_field(field) {

    }
    function enable_button(field) {
      console.debug('enabling:', '#btn-' + field);
      $('#btn-' + field).removeAttr('disabled');
    }
    function disable_button(field) {
      console.debug('disabling:', '#btn-' + field);
      $('#btn-' + field).attr('disabled', true);
    }
    function process_group(group) {
      var groupsize = 0;
      if (group.nodeName == 'int' || group.nodeName == 'string') {
        groupsize += parseInt($(group).attr('size'));
      } else if (group.nodeName == 'eventid') {
        groupsize += 8;
      } else if (group.nodeName == 'group') {
        if ($.isNumeric($(group).attr('offset'))) {
          groupsize += parseInt($(group).attr('offset'));
        }
        $(group).children().each(function (i, c) {
          groupsize += process_group(c);
        });
      }
      return groupsize;
    }
    function calculate_offsets(cdi, space) {
      var offsets = {};
      var segment = $(cdi).find('segment').filter(
        function (i, e) {
          return parseInt($(e).attr('space')) === space && parseInt($(e).attr('origin')) > 0;
        });
      var offs = parseInt($(segment).attr('origin'));
      $(segment).children().each(function (i, e) {
        var group_name = 'unknown';
        if (space === 251) {
          group_name = 'node_info';
        } else {
          $(e.children).each(function (i, e) {
            if (e.nodeName === 'name') {
              group_name = $(e).text();
            }
          });
        }
        var replica_count = 1;
        if ($(e).attr('replication')) {
          replica_count = parseInt($(e).attr('replication'));
        }
        var groupsize = 0;
        $(e.children).each(function (i, c) {
          groupsize += process_group(c);
        });
        offsets[group_name] = { size: groupsize, replicas: replica_count, offset: offs };
        offs += (groupsize * replica_count);
      });
      return offsets;
    }
    function generate_cdi_dynamic_content(space, group, offset) {
      var size = 0;
      // these nodes can be safely dropped from rendering
      if (group.nodeName === 'name' || group.nodeName === 'description' || group.nodeName === 'repname') {
        return ['', 0];
      }
      var content = '';
      var node_data_type = group.nodeName;
      var node_name = '';
      var is_mapped = false;
      var mapped = undefined;
      var node_description = '';
      var node_alias = String.format('cdi_{0}', Math.random()).replace(/\./g, '_');
      for (child = 0; child < group.children.length; child++) {
        if (group.children[child].nodeName === 'name') {
          node_name = $(group.children[child]).text();
        } else if (group.children[child].nodeName === 'map') {
          is_mapped = true;
          mapped = group.children[child];
        } else if (group.children[child].nodeName === 'description') {
          node_description = $(group.children[child]).text().replace(/\n/g, '<br/>');
        }
      };
      if (is_mapped) {
        size = parseInt($(group).attr('size'));
        console.groupCollapsed('Mapped:', node_name, 'offset:', offset, 'size:', size, 'description:', node_description);
        content += '<div class="columns">';
        content += String.format('<div class="column"><label for="{0}">{1}:</label></div>', node_alias, node_name);
        content += String.format('<div class="column column-6"><select id="{0}" data-offset="{1}" data-type="{2}" data-size="{3}" oninput="enable_button(\'save-{0}\')">', node_alias, offset, node_data_type, size);
        $(mapped.children).each(function (i, e) {
          console.log($(e).find('value').text(), '=>', $(e).find('property').text());
          content += String.format('<option value="{0}">{1}</option>', $(e).find('property').text(), $(e).find('value').text());
        });
        content += '</select></div>';
        content += String.format('<div class="column"><div class="btn-group"><button class="btn btn-primary btn-sm" id="btn-save-{0}" disabled onclick="save_cdi_field(this);">Save</button>', node_alias);
        content += String.format('<button class="btn btn-primary btn-sm" id="btn-refresh-{0}" onclick="refresh_cdi_field(this);">Refresh</button></div>', node_alias);
        content += '</div></div>';
        content += String.format('<div class="columns"><div class="column"><small>{0}</small></div></div>', node_description);
        cdi_loaders.push(async () => {
          const response = await fetch(String.format(ip + '/cdi?offs={0}&size={1}&type={2}', offset, size, node_data_type));
          if (response.headers.has('Content-Length')) {
            $('#' + node_alias).val(await response.text());
          } else {
            $('#' + node_alias).val(0);
          }
        });
        console.groupEnd();
      } else if (node_data_type === 'group') {
        if ($.isNumeric(parseInt($(group).attr('offset'))) && node_name === '') {
          size = parseInt($(group).attr('offset'));
          node_name = 'hidden'
        }
        if (group.children.length > 0) {
          if (node_name != '') {
            content += String.format('<fieldset><legend>{0}:</legend>', node_name);
            console.groupCollapsed(node_name);
          } else {
            console.groupCollapsed('unnamed group');
          }
          content += String.format('<div class="columns"><div class="column"><small>{0}</small></div></div>', node_description);
          $(group.children).each(function (i, e) {
            var res = generate_cdi_dynamic_content(space, e, offset + size);
            content += res[0];
            size += res[1];
          });
          console.groupEnd();
          if (node_name != '') {
            content += '</fieldset>';
          }
        }
      } else if (node_name !== '') {
        if (node_data_type === 'eventid') {
          size = 8; // events are always 8 bytes
        } else {
          size = parseInt($(group).attr('size'));
        }
        console.log('Entry:', node_name, 'offset:', offset, 'size:', size, 'datatype:', node_data_type, 'description:', node_description);
        content += '<div class="columns">';
        content += String.format('<div class="column"><label class="form-label" for="{0}">{1}:</label></div>', node_alias, node_name);
        content += String.format('<div class="column column-6"><input class="form-input" type="text" id="{0}" data-offset="{1}" data-type="{2}" data-size="{3}" oninput="enable_button(\'save-{0}\')"></div>', node_alias, offset, node_data_type, size);
        content += String.format('<div class="column"><div class="btn-group"><button class="btn btn-primary btn-sm" id="btn-save-{0}" disabled onclick="save_cdi_field(this);">Save</button>', node_alias);
        content += String.format('<button class="btn btn-primary btn-sm" id="btn-refresh-{0}" onclick="refresh_cdi_field(this);">Refresh</button></div>', node_alias);
        content += '</div></div>';
        content += String.format('<div class="columns"><div class="column"><small>{0}</small></div></div>', node_description)
        cdi_loaders.push(async () => {
          const response = await fetch(String.format(ip + '/cdi?offs={0}&size={1}&type={2}', offset, size, node_data_type));
          if (response.headers.has('Content-Length')) {
            var value = await response.text();
            if (node_data_type === 'eventid') {
              value = pad_hex(value, 16);
            }
            $('#' + node_alias).val(value);
          } else {
            $('#' + node_alias).val('');
          }
        });
      }
      return [content, size];
    }
    function cdi_dynamic_group(cdi, space, group, target_selector, offsets, xpath = String.format("//segment[@space='{0}']/group[name[text()='{1}']]", space, group)) {
      var nodes = cdi.evaluate(xpath, cdi);
      var node = nodes.iterateNext();
      var offs = offsets[group].offset;
      var group_name = 'unnamed';
      $(node.children).each(function (i, e) {
        if (e.nodeName === 'name') {
          group_name = $(e).text();
        }
      });
      console.groupCollapsed(group_name, 'segment:', space);
      if (offsets[group].replicas === 1) {
        $(node.children).each(function (i, e) {
          var rendered = generate_cdi_dynamic_content(space, e, offs);
          $(target_selector).append(rendered[0]);
          offs += rendered[1];
        });
      } else {
        var group_tabs = '<div class="row tabs">';
        var group_content = '';
        var alias = $(node).find('repname').text();
        var group_id = group.replace(/ /g, '_');
        for (replica = 1; replica <= offsets[group].replicas; replica++) {
          console.groupCollapsed(alias, replica);
          group_tabs += String.format('<a href="#" class="button" id="{0}-{1}">{2} {1}</a>', group_id, replica, alias);
          group_content += String.format('<div class="well" id="rep-{0}-{1}" style="display: {3};"><fieldset><legend>{2} {1}</legend>', group_id, replica, alias, replica > 1 ? 'none' : 'block');
          $(node).children().each(function (i, e) {
            var rendered = generate_cdi_dynamic_content(space, e, offs);
            group_content += rendered[0];
            offs += rendered[1];
          });
          group_content += '</fieldset></div>';
          console.groupEnd();
        }
        $(target_selector).append(group_tabs);
        $(target_selector).append(group_content);
        $(String.format('[id^={0}-]', group_id)).on('click', function (evt) {
          var selected_tab = $(evt.target).attr('id');
          var tab_group = selected_tab.substring(0, selected_tab.lastIndexOf('-'));
          $(String.format('[id^=rep-{0}', tab_group)).filter(function (i, e) { return $(e).attr('id') != $(evt.target).attr('id'); }).each(function (i, other_tab) {
            $('#' + $(other_tab).attr('id')).hide();
            $(other_tab).removeClass('active');
            $(other_tab).addClass('inactive');
            return true;
          });
          var tab_content = String.format('#rep-{0}', selected_tab);
          $(tab_content).show();
          $(evt.target).addClass('active');
          $(evt.target).removeClass('inactive');
        });
      }
      console.groupEnd();
    }
  </script>
</body>

</html>